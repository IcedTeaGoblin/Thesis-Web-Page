<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="assets/css/styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="assets\js\aoi-selection.js"></script>
    <script src="assets\js\circle-packing.js"></script>
    <script src="assets\js\eyetracking.js"></script>
    <script src="assets\js\calibration.js"></script>
    <script src="assets\js\circle-packing.js"></script>
    <script src="assets\js\link-tree.js"></script>
</head>

<!--Main body of the webpage-->
<body class="h_main">
    <!--Display for the introductory screen-->
    <div id="introPage" style="display:flex;flex-direction:column;justify-content:space-between;height:100px;">
        <div class="h_intro_text">Data Visualization With Ontologies</div>
        <button class="h_begin_button" onclick="changePage()">Continue</button>
    </div>
    <div id="backgroundPage" class="h_sub" style="display:none">
        <!--Display for information regarding the study, and how participants should approach it-->
        <div class="h_intro_info">
            <div style="display:flex;min-height:100%;width:100%;background-color:rgb(240,240,240);flex-direction:column;justify-content:space-between;">
                <div style="font-size:50px;padding:20px;color:rgb(25,25,25);">Background Information</div>

                <div>
                    <div class="h_background_bullet_title">WHAT IS AN ONTOLOGY?</div>
                    <div class="h_background_bullet_text">An ontology is a structured way to organize and define relationships between concepts in a particular domain, like a map for understanding how ideas connect</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">WHAT IS A "CLASS" IN ONTOLOGY?</div>
                    <div class="h_background_bullet_text">A class in an ontology is a category or group that defines a set of similar things, like a label for a collection of related items</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">WHAT ARE PARENT AND SUBCLASSES?</div>
                    <div class="h_background_bullet_text">In ontology, some classes will "belong" to others like branches off of a tree. The tree is a parent class while each branch is a subclass or child class. For example: the class "Parent" will have a "Son" subclass and a "Daughter" subclass</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">WHAT IS A RELATIONSHIP IN ONTOLOGY?</div>
                    <div class="h_background_bullet_text">A relationship is a link between two or more entities/classes in ontology. There are many different kinds of relationships, many of which you will see during our study</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">WHAT SUBJECTS ARE GOING TO BE COVERED?</div>
                    <div class="h_background_bullet_text">The ontology models in this study will cover a variety of subjects. Here are a few key points to help understand the models better:
                        <br>- Despite how similar the names may sound, "Opera", "Operetta" and "Musical" are all different types of musical performances
                        <br>- Many names for sports are shared across the world. However, "Football" is referred to in the United States as "Soccer" despite being identical sports
                        <br>- Restaurants will often have sections for different types of menu options that usually do not overlap. This can include a section for vegetarian dishes, with all other dishes falling under the "standard" options
                    </div>
                </div>
            </div>
        </div>
        <!--Dispaly for information regarding the ontology models used, and information that could make answering them easier and more intuitive-->
        <div class="h_intro_background">
            <div style="display:flex;height:90%;width:100%;background-color:rgb(240,240,240);flex-direction:column;justify-content:space-between;">
                <div style="font-size:50px;padding:20px;color:rgb(25,25,25);">Relationships Used</div>

                <div>
                    <div class="h_background_bullet_title">DisjointWith</div>
                    <div class="h_background_bullet_text">The classes do not and cannot share any subclasses or values. For example:<br>Class A is disjointWith Class B. Class A = [1, 2, 3], Class B = [4, 5, 6]</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">SubclassOf</div>
                    <div class="h_background_bullet_text">This class is a subclass of a parent class and cannot exist without it. For example:<br>The class "Child" is a subclass of "Parent" and cannot exist without it</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">IntersectionOf</div>
                    <div class="h_background_bullet_text">This class will be an intersection of all classes inside of it. This means it will only contain elements shared by all subclasses. For example:<br>Class A is an intersection of classes B and C. B = [1, 2, 3], C = [3, 4, 5], so A = [3]</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">SameAs</div>
                    <div class="h_background_bullet_text">This class is identical to the other, and is only different by name/label. For example:<br>The "Human" class is sameAs the "Person" class</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">UnionOf</div>
                    <div class="h_background_bullet_text">This class will be a union of all classes inside of it. This means it will contain all elements from all subclasses together with no duplicates. For example<br>Class A is an intersection of classes B and C. B = [1, 2, 3], C = [3, 4, 5], so A = [1, 2, 3, 4, 5]</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">ComplementOf</div>
                    <div class="h_background_bullet_text">If something is not a member of this class, it MUST be a member of the other and vice-versa, but never both. This can only be applied between two classes. For example:<br>The classes "Mammal" and "Non-Mammal" are complement of since any element must be one or the other, and never both</div>
                </div>

            </div>
            <button class="h_begin_button" onclick="changePage()">Begin Test</button>
        </div>
    </div>

    <!--Display for questions and answers, used for questionaire participation-->
    <div id="questionPage" class="h_sub" style="display:none">
        <script>
            let pageState = 0;
        </script>

        <!--Div for questions and answers-->
        <div class="h_question">
            <!--Div for question and answer-option text-->
            <div class = "h_sub_question">
                <div id="questionText" style="padding:20px;width:100% - 40px;">
                    Question1
                </div>
                <div id="answersText" style="white-space: pre-line;padding:20px;width:100% - 40px;">
                    Answers1
                </div>
            </div>

            <!--Container for the answer buttons-->
            <div class="h_answer_box">
                <button id="pageButton" class="ans_button" onclick="changePage(0)">Answer A</button>
                <button id="pageButton" class="ans_button" onclick="changePage(1)">Answer B</button>
                <button id="pageButton" class="ans_button" onclick="changePage(2)">Answer C</button>
                <button id="pageButton" class="ans_button" onclick="changePage(3)">Answer D</button>
            </div>

            <!--Script containing the questions and answers for the question page-->
            <script>
                const questionNum = 15;

                //List of all questions
                const pageQuestions = 
                {
                    1: "Question 1:\n\nGiven the current model, can an entity be both an #Opera and an #Operetta?",
                    2: "Question 2:\n\nGiven the current model, can an entity be both an #Operetta and a #MusicDrama?",
                    3: "Question 3:\n\nHow many objects will be left in the #Opera intersection?",
                    4: "Question 4:\n\nHow many subclasses does the class #MusicDrama contain?",
                    5: "Question 5:\n\nHow many total connections do you see in this model?",
                    6: "Question 6:\n\nIs there a relationship between #USSoccerTeam and #TennisTeam?",
                    7: "Question 7:\n\nWhich class in the model is #FootballTeam mapped to? ",
                    8: "Question 8:\n\nHow many total connections do you see in this model?",
                    9: "Question 9:\n\nWould it be logical to put a sameAs relationship between #FootballTeam and a class #SwimmingTeam?",
                    10: "Question 10:\n\nHow many mappings are there from the #Sports class?",
                    11: "Question 11:\n\nYou have an entity “Sandwich” that is not a vegetarian option. Which class would it then be mapped to?",
                    12: "Question 12:\n\nWould the model still function if a third class #VeganOptions was added?",
                    13: "Question 13:\n\nHow many total connections do you see in this model?",
                    14: "Question 14:\n\nAre all members of #VegetarianOptions and #StandardOptions members of the #RestaurantItems class?",
                    15: "Question 15:\n\nHow many connections does the #VegetarianOptions class have?",
                };

                //List of all answers
                const pageAnswers = 
                {
                    1: "A) Yes, they will always be both\nB) No, they can never be both\nC) Yes, but only if specified\nD) No, an entity cannot be either",
                    2: "A) Yes, they will always be both\nB) No, they can never be both\nC) Yes, but only if specified\nD) No, an entity cannot be either",
                    3: "A) 1\nB) 2\nC) 3\nD) 4",
                    4: "A) 2\nB) 3\nC) 4\nD) 5",
                    5: "A) 1\nB) 3\nC) 5\nD) 7",
                    6: "A) Yes, they are disjoint\nB) No, they are completely separate\nC) Yes, they are contained in the same class\nD) Yes, they are equivalent classes",
                    7: "A) #TennisTeam\nB) #USSoccerTeam\nC) #BowlingTeam\nD) No classes",
                    8: "A) 1\nB) 2\nC) 3\nD) 4",
                    9: "A) Yes, they are both #Sports\nB) Yes, they are both US teams\nC) No, two classes cannot be SameAs\nD) No, they are differnt sports",
                    10: "A) 1\nB) 2\nC) 3\nD) 4",
                    11: "A) #VegetarianOptions\nB) #StandardOptions\nC) #VeganOptions\nD) No classes",
                    12: "A) Yes, there can be infinite complementary classes\nB) Yes, 3 classes are required for complementOf\nC) No, complementOf only works with 2 classes\nD) No, Vegan and Vegetarian are the same",
                    13: "A) 1\nB) 2\nC) 3\nD) 4",
                    14: "A) Yes, they are required to be\nB) Yes, but only if specified\nC) No, they are members of #MenuItems\nD) No, they are not members of any class",
                    15: "A) 3\nB) 2\nC) 1\nD) 0"
                };

                //List of all correct answers (by index)
                const pageSolutions = [1, 0, 3, 2, 1, 2, 1, 0, 3, 2, 1, 2, 1, 0, 2];
            </script>
        </div>
        
        <!--Div for visualization, implementing D3 later on-->
        <div class="h_visual">
            <div id="tree-container" style="width:100%;height:100%;background-color:rgb(240,240,240);"></div>
        </div>

        <canvas id="aoiCanvas" width="1920" height="1080" style="position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none;"></canvas>
        <!--<button onclick="enableAOISelection()" style="position: relative; z-index: 11;">Start AOI Selection</button>
        <button onclick="saveAOIs()" style="position: relative; z-index: 11; margin-top: 10px;">Save AOIs</button>-->
    </div>

    <!--Display for eye-tracking calibration-->
    <div id="h_calibration" class="h_calibration" style="Display:None">
        <div id="calibration-container" class="calibration_parent">
            
        </div>
    </div>

    <!--Display for the final thank you and results page-->
    <div id="outroPage" class="h_sub" style="Display:none">
        <div id="outroText" class="h_outro">
            Final
        </div>
    </div>

    <!--Script for acting on keyboard shortcuts-->
    <script>
        //Event listener checking for keybard input 
        document.addEventListener('keydown', function (event) {
            //Keyboard shortcut for enabling AOI selection (Ctrl+Z)
            if (event.ctrlKey && event.key === 'z') {
                //Prevent default browser activity, and instead run the function to enable AOI selction
                event.preventDefault();
                enableAOISelection();
            }
            //Keyboard shortcut for downloaded selected AOI selections (Ctrl+X)
            else if (event.ctrlKey && event.key === 'x') {
                //Prevent default browser activity, and instead run the function to save AOI selections as a JSON file 
                event.preventDefault();
                saveAOIs();
            }
            //Keyboard shortcut for calling the calibration sequence (Ctrl+C)
            else if (event.ctrlKey && event.key === 'c') {
                //Prevent default browser activity, and instead run the function to begin the calibration sequence 
                event.preventDefault();
                updateFrontEnd(is_calib=true);
                console.log("calibration");
            }
            else if (event.ctrlKey && event.key === 'd') {
                event.preventDefault(); // Prevent default browser action
                downloadGazeDataCSV(); // Trigger CSV download
                console.log("Gaze data CSV downloaded!");
            }
        });
    </script>

    <!--Script containing the logic for tracking, iterating and updating page information-->
    <script>
        //Variable that will keep track of user answers to questions
        let answers = []
        //Variable t hat will keep track of the amount of time a user spends on each page
        let page_time = []
        //Page number variable, used to track the current page state
        let page_value = -1;

        //Establish constant variables for the intro, question and outro pages
        const menuIntro = document.getElementById("introPage");
        const menuBackground = document.getElementById("backgroundPage")
        const menuQuestion = document.getElementById("questionPage")
        const menuOutro = document.getElementById("outroPage");
        const continueButton = document.getElementById("pageButton");
        const menuCalibration = document.getElementById("h_calibration");

        //Establish a starting variable for keeping track of time when navigating the page. This should begin as soon as the web page is accessed
        let startTime = new Date().getTime();

        // Define the data for the tree
        const data = {
            "name": "United States",
            "children": [
                {
                    "name": "California",
                    "children": [
                        {"name": "San Bernardino"},
                        {"name": "Los Angeles"}
                    ]
                },
                {
                    "name": "Texas",
                    "children": [
                        {"name": "Dallas"}
                    ]
                }
            ]
        }

        const data2 = {
            "name": "disjoint",
            "children": [
                {
                "name": "Music Drama", "value": 800,
                "children": [
                {
                    "name": "Opera", "value": 200
                },
                {
                    "name": "Opereta", "value": 300
                },
                {
                    "name": "Musical", "value": 400
                }
                ]
                }
            ]
        }

        const container = document.getElementById("tree-container");
        const containerWidth = 851;
        const containerHeight = 851;

        // Set up tree options if desired
        const options = {
            width: containerWidth,
            height: containerHeight,
            label: d => d.name, // Display the name property
            fill: "#66c2a5",
            stroke: "#1b9e77"
        };
    
        // Create the tree visualization
        const svg = chart(data2, options);

        const svg2 = document.createElement("img");
        svg2.src = "../1.png";
        svg2.style.width = "100%"
        svg2.style.height = "100%"

        const svg3 = document.createElement("img");
        svg3.src = "../treemap.png"; 
        svg3.style.width = "100%"
        svg3.style.height = "100%"
    
        // Append the SVG to the div container
        document.getElementById("tree-container").appendChild(svg);

        function disableCalibration()
        {
            menuCalibration.style.display="none"
            menuBackground.style.display="flex";
        }
        window.disableCalibration = disableCalibration;

        function startTrackingGaze() {
            console.log("Gaze tracking started!");
            WebGazer.setGazeListener((data, timestamp) => {
                if (data) {
                    gazeData.push({
                        x: data.x, // Gaze X coordinate
                        y: data.y, // Gaze Y coordinate
                        timestamp: timestamp // Time of the gaze point
                    });
                }
            }).begin();
        }

        function downloadGazeDataCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "X,Y,Timestamp\n"; // Add CSV header
        
            if (gazeData.length > 0) {
                gazeData.forEach(row => {
                    csvContent += `${row.x},${row.y},${row.timestamp}\n`;
                });
            } else {
                console.warn("No gaze data to download. Creating an empty file.");
            }
        
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "raw_gaze_data.csv");
            document.body.appendChild(link); // Append link to body
            link.click(); // Trigger download
            document.body.removeChild(link); // Remove link after download
        }
        

        let gazeData = [];
        let gazeTrackingEnabled = false;

        function changePage(ans = -1) {
            if (ans !== -1) answers.push(ans);
            page_value = page_value + 1;

            // Start tracking gaze data when the question-and-answer section begins
            if (page_value === 1 && !gazeTrackingEnabled) {
                startTrackingGaze(); // Start gaze tracking
                gazeTrackingEnabled = true; // Ensure tracking starts only once
            }

            if (page_value > questionNum) {
                final_score = checkAnswers(answers);
                menuQuestion.style.display = "none";
                menuOutro.style.display = "flex";
                continueButton.style.display = "none";

                document.getElementById("outroText").textContent = "Thank you for participating!";
                console.log("Answers:", answers);
                console.log("Page Times:", page_time);
                console.log("Gaze Data:", gazeData); // Log gaze data for debugging
            } else if (page_value > 0) {
                menuIntro.style.display = "none";
                menuQuestion.style.display = "flex";
                document.getElementById("questionText").innerText = pageQuestions[page_value];
                document.getElementById("answersText").innerText = pageAnswers[page_value];
            }

            const endTime = new Date().getTime();
            page_time.push((endTime - startTime) / 1000.0);
            startTime = endTime;

            updateFrontEnd();
        }
        //Function for updating visuals based on the new value of page_value
        //Iterates through different if-statements to check whether the condition for displaying certain pages is met 
        function updateFrontEnd(is_calib = false)
        {
            
            //Perform the calibration sequence, which should not affect the page value
            if(is_calib == true && page_value == 0)
            {
                console.log("calibration sequence");
                menuBackground.style.display = "none";
                menuCalibration.style.display = "flex";
                window.startCalibration();
                return;
            }

            //If the current page is a question & visual page (page_value is between 1 and 15)
            if(page_value == 0)
            {
                menuIntro.style.display = "none";
                menuBackground.style.display = "flex";
            }
            else if(page_value > 0 && page_value <= 15)
            {
                //Remove the visualization
                menuBackground.style.display = "none";
                menuQuestion.style.display = "flex";

                document.getElementById("questionText").innerText = pageQuestions[page_value];
                document.getElementById("answersText").innerText = pageAnswers[page_value];

                //If the current page is ready to move onto the second visualization (question 6)
                if (page_value == 6)
                {
                    document.getElementById("tree-container").removeChild(svg);
                    document.getElementById("tree-container").appendChild(svg2);
            
                }
                //If the current page is ready to move onto the third visualization (question 11)
                else if (page_value == 11)
                {
                    document.getElementById("tree-container").removeChild(svg2);
                    document.getElementById("tree-container").appendChild(svg3);
                }
            }
            //If the current page has exceeded the number of questions, meaning it will now end the study simulation
            else if(page_value > 15)
            {
                //Navigate to the final end-page of the simulation
                menuQuestion.style.display = "none";
                menuOutro.style.display = "flex";
                continueButton.style.display="none";

                //Display the final score of the participant (OPTIONAL)
                document.getElementById("outroText").textContent = ("Thank you for participating!");

                console.log(answers);
                console.log(page_time)
            }
        }

        function checkAnswers(ans_list)
        {
            let correct_ans = 0
            for (i = 0; i < questionNum; i++)
            {
                if (ans_list[i] === pageSolutions[i])
                {
                    correct_ans++;
                }
            }
            return correct_ans;
        }
    </script>
</body>