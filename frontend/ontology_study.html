<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="assets/css/styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="assets/js/webgazer.js"></script>
    <script src="assets/js/aoi-selection.js"></script>
    <script src="assets/js/circle-packing.js"></script>
    <script src="assets/js/eyetracking.js"></script>
    <script src="assets/js/calibration.js"></script>
    <script src="assets/js/link-tree.js"></script>
</head>

<!--Main body of the webpage-->
<body class="h_main">
    <!--Display for the introductory screen-->
    <div id="introPage" style="display:flex;flex-direction:column;justify-content:space-between;height:100px;">
        <div class="h_intro_text">Data Visualization With Ontologies</div>
        <button class="h_begin_button" onclick="changePage()">Continue</button>
    </div>
    <div id="backgroundPage" class="h_sub" style="display:none">
        <!--Display for information regarding the study, and how participants should approach it-->
        <div class="h_intro_info">
            <div style="display:flex;min-height:100%;width:100%;background-color:rgb(240,240,240);flex-direction:column;justify-content:space-between;">
                <div style="font-size:50px;padding:20px;color:rgb(25,25,25);">Background Information</div>

                <div>
                    <div class="h_background_bullet_title">WHAT IS AN ONTOLOGY?</div>
                    <div class="h_background_bullet_text">An ontology is a structured way to organize and define relationships between concepts in a particular domain, like a map for understanding how ideas connect</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">WHAT IS A "CLASS" IN ONTOLOGY?</div>
                    <div class="h_background_bullet_text">A class in an ontology is a category or group that defines a set of similar things, like a label for a collection of related items</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">WHAT ARE PARENT AND SUBCLASSES?</div>
                    <div class="h_background_bullet_text">In ontology, some classes will "belong" to others like branches off of a tree. The tree is a parent class while each branch is a subclass or child class. For example: the class "Parent" will have a "Son" subclass and a "Daughter" subclass</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">WHAT IS A RELATIONSHIP IN ONTOLOGY?</div>
                    <div class="h_background_bullet_text">A relationship is a link between two or more entities/classes in ontology. There are many different kinds of relationships, many of which you will see during our study</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">WHAT SUBJECTS ARE GOING TO BE COVERED?</div>
                    <div class="h_background_bullet_text">The ontology models in this study will cover a variety of subjects. Here are a few key points to help understand the models better:
                        <br>- Despite how similar the names may sound, "Opera", "Operetta" and "Musical" are all different types of musical performances
                        <br>- Many names for sports are shared across the world. However, "Football" is referred to in the United States as "Soccer" despite being identical sports
                        <br>- Restaurants will often have sections for different types of menu options that usually do not overlap. This can include a section for vegetarian dishes, with all other dishes falling under the "standard" options
                    </div>
                </div>
            </div>
        </div>
        <!--Dispaly for information regarding the ontology models used, and information that could make answering them easier and more intuitive-->
        <div class="h_intro_background">
            <div style="display:flex;height:90%;width:100%;background-color:rgb(240,240,240);flex-direction:column;justify-content:space-between;">
                <div style="font-size:50px;padding:20px;color:rgb(25,25,25);">Relationships Used</div>

                <div>
                    <div class="h_background_bullet_title">DisjointWith</div>
                    <div class="h_background_bullet_text">The classes do not and cannot share any subclasses or values. For example:<br>Class A is disjointWith Class B. Class A = [1, 2, 3], Class B = [4, 5, 6]</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">SubclassOf</div>
                    <div class="h_background_bullet_text">This class is a subclass of a parent class and cannot exist without it. For example:<br>The class "Child" is a subclass of "Parent" and cannot exist without it</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">IntersectionOf</div>
                    <div class="h_background_bullet_text">This class will be an intersection of all classes inside of it. This means it will only contain elements shared by all subclasses. For example:<br>Class A is an intersection of classes B and C. B = [1, 2, 3], C = [3, 4, 5], so A = [3]</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">SameAs</div>
                    <div class="h_background_bullet_text">This class is identical to the other, and is only different by name/label. For example:<br>The "Human" class is sameAs the "Person" class</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">UnionOf</div>
                    <div class="h_background_bullet_text">This class will be a union of all classes inside of it. This means it will contain all elements from all subclasses together with no duplicates. For example<br>Class A is an intersection of classes B and C. B = [1, 2, 3], C = [3, 4, 5], so A = [1, 2, 3, 4, 5]</div>
                </div>
                <div>
                    <div class="h_background_bullet_title">ComplementOf</div>
                    <div class="h_background_bullet_text">If something is not a member of this class, it MUST be a member of the other and vice-versa, but never both. This can only be applied between two classes. For example:<br>The classes "Mammal" and "Non-Mammal" are complement of since any element must be one or the other, and never both</div>
                </div>

            </div>
            <button class="h_begin_button" onclick="changePage()">Begin Test</button>
        </div>
    </div>

    <!--Display for questions and answers, used for questionaire participation-->
    <div id="questionPage" class="h_sub" style="display:none">
        <script>
            let pageState = 0;
        </script>

        <!--Div for questions and answers-->
        <div class="h_question">
            <!--Div for question and answer-option text-->
            <div class = "h_sub_question">
                <div id="questionText" style="padding:20px;width:100% - 40px;">
                    Question1
                </div>
                <div id="answersText" style="white-space: pre-line;padding:20px;width:100% - 40px;">
                    Answers1
                </div>
            </div>

            <!--Container for the answer buttons-->
            <div class="h_answer_box">
                <button id="pageButton" class="ans_button" onclick="changePage(0)">Answer A</button>
                <button id="pageButton" class="ans_button" onclick="changePage(1)">Answer B</button>
                <button id="pageButton" class="ans_button" onclick="changePage(2)">Answer C</button>
                <button id="pageButton" class="ans_button" onclick="changePage(3)">Answer D</button>
            </div>

            <!--Script containing the questions and answers for the question page-->
            <script>
                const questionNum = 10;

                //List of all questions
                const pageQuestions = 
                [{
                    1: "Question 1:\n\n Question 1-1",
                    2: "Question 2:\n\n Question 1-2",
                    3: "Question 3:\n\n Question 1-3",
                    4: "Question 4:\n\n Question 1-4",
                    5: "Question 5:\n\n Question 1-5",
                    6: "Question 6:\n\n Question 1-6",
                    7: "Question 7:\n\n Question 1-7",
                    8: "Question 8:\n\n Question 1-8",
                    9: "Question 9:\n\n Question 1-9",
                    10: "Question 10:\n\n Question 1-10",
                },
                {
                    1: "Question 1:\n\n Question 2-1",
                    2: "Question 2:\n\n Question 2-2",
                    3: "Question 3:\n\n Question 2-3",
                    4: "Question 4:\n\n Question 2-4",
                    5: "Question 5:\n\n Question 2-5",
                    6: "Question 6:\n\n Question 2-6",
                    7: "Question 7:\n\n Question 2-7",
                    8: "Question 8:\n\n Question 2-8",
                    9: "Question 9:\n\n Question 2-9",
                    10: "Question 10:\n\n Question 2-10",
                },
                {
                    1: "Question 1:\n\n Question 3-1",
                    2: "Question 2:\n\n Question 3-2",
                    3: "Question 3:\n\n Question 3-3",
                    4: "Question 4:\n\n Question 3-4",
                    5: "Question 5:\n\n Question 3-5",
                    6: "Question 6:\n\n Question 3-6",
                    7: "Question 7:\n\n Question 3-7",
                    8: "Question 8:\n\n Question 3-8",
                    9: "Question 9:\n\n Question 3-9",
                    10: "Question 10:\n\n Question 3-10",
                }];

                //List of all answers
                const pageAnswers = 
                [{
                    1: "A) Answer 1-1-1\nB) Answer 1-1-2\nC) Answer 1-1-3\nD) Answer 1-1-4",
                    2: "A) Answer 1-2-1\nB) Answer 1-2-2\nC) Answer 1-2-3\nD) Answer 1-2-4",
                    3: "A) Answer 1-3-1\nB) Answer 1-3-2\nC) Answer 1-3-3\nD) Answer 1-3-4",
                    4: "A) Answer 1-4-1\nB) Answer 1-4-2\nC) Answer 1-4-3\nD) Answer 1-4-4",
                    5: "A) Answer 1-5-1\nB) Answer 1-5-2\nC) Answer 1-5-3\nD) Answer 1-5-4",
                    6: "A) Answer 1-6-1\nB) Answer 1-6-2\nC) Answer 1-6-3\nD) Answer 1-6-4",
                    7: "A) Answer 1-7-1\nB) Answer 1-7-2\nC) Answer 1-7-3\nD) Answer 1-7-4",
                    8: "A) Answer 1-8-1\nB) Answer 1-8-2\nC) Answer 1-8-3\nD) Answer 1-8-4",
                    9: "A) Answer 1-9-1\nB) Answer 1-9-2\nC) Answer 1-9-3\nD) Answer 1-9-4",
                    10: "A) Answer 1-10-1\nB) Answer 1-10-2\nC) Answer 1-10-3\nD) Answer 1-10-4",
                },
                {
                    1: "A) Answer 2-1-1\nB) Answer 2-1-2\nC) Answer 2-1-3\nD) Answer 2-1-4",
                    2: "A) Answer 2-2-1\nB) Answer 2-2-2\nC) Answer 2-2-3\nD) Answer 2-2-4",
                    3: "A) Answer 2-3-1\nB) Answer 2-3-2\nC) Answer 2-3-3\nD) Answer 2-3-4",
                    4: "A) Answer 2-4-1\nB) Answer 2-4-2\nC) Answer 2-4-3\nD) Answer 2-4-4",
                    5: "A) Answer 2-5-1\nB) Answer 2-5-2\nC) Answer 2-5-3\nD) Answer 2-5-4",
                    6: "A) Answer 2-6-1\nB) Answer 2-6-2\nC) Answer 2-6-3\nD) Answer 2-6-4",
                    7: "A) Answer 2-7-1\nB) Answer 2-7-2\nC) Answer 2-7-3\nD) Answer 2-7-4",
                    8: "A) Answer 2-8-1\nB) Answer 2-8-2\nC) Answer 2-8-3\nD) Answer 2-8-4",
                    9: "A) Answer 2-9-1\nB) Answer 2-9-2\nC) Answer 2-9-3\nD) Answer 2-9-4",
                    10: "A) Answer 2-10-1\nB) Answer 2-10-2\nC) Answer 2-10-3\nD) Answer 2-10-4",
                },
                {
                    1: "A) Answer 3-1-1\nB) Answer 3-1-2\nC) Answer 3-1-3\nD) Answer 3-1-4",
                    2: "A) Answer 3-2-1\nB) Answer 3-2-2\nC) Answer 3-2-3\nD) Answer 3-2-4",
                    3: "A) Answer 3-3-1\nB) Answer 3-3-2\nC) Answer 3-3-3\nD) Answer 3-3-4",
                    4: "A) Answer 3-4-1\nB) Answer 3-4-2\nC) Answer 3-4-3\nD) Answer 3-4-4",
                    5: "A) Answer 3-5-1\nB) Answer 3-5-2\nC) Answer 3-5-3\nD) Answer 3-5-4",
                    6: "A) Answer 3-6-1\nB) Answer 3-6-2\nC) Answer 3-6-3\nD) Answer 3-6-4",
                    7: "A) Answer 3-7-1\nB) Answer 3-7-2\nC) Answer 3-7-3\nD) Answer 3-7-4",
                    8: "A) Answer 3-8-1\nB) Answer 3-8-2\nC) Answer 3-8-3\nD) Answer 3-8-4",
                    9: "A) Answer 3-9-1\nB) Answer 3-9-2\nC) Answer 3-9-3\nD) Answer 3-9-4",
                    10: "A) Answer 3-10-1\nB) Answer 3-10-2\nC) Answer 3-10-3\nD) Answer 3-10-4",
                }
                ];

                //List of all correct answers (by index)
                const pageSolutions =   [[1, 0, 3, 2, 1, 2, 1, 0, 3, 2], 
                                        [1, 0, 3, 2, 1, 2, 1, 0, 3, 2], 
                                        [1, 0, 3, 2, 1, 2, 1, 0, 3, 2]];
            </script>
        </div>
        
        <!--Div for visualization, implementing D3 later on-->
        <div class="h_visual">
            <div id="tree-container" style="width:100%;height:100%;background-color:rgb(240,240,240);"></div>
        </div>

        <canvas id="aoiCanvas" width="1920" height="1080" style="position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none;"></canvas>
        <!--<button onclick="enableAOISelection()" style="position: relative; z-index: 11;">Start AOI Selection</button>
        <button onclick="saveAOIs()" style="position: relative; z-index: 11; margin-top: 10px;">Save AOIs</button>-->
    </div>

    <!--Display for eye-tracking calibration-->
    <div id="h_calibration" class="h_calibration" style="Display:None">
        <div id="calibration-container" class="calibration_parent">
            
        </div>
    </div>

    <!--Display for the final thank you and results page-->
    <div id="outroPage" class="h_sub" style="Display:none">
        <div id="outroText" class="h_outro">
            Final
        </div>
    </div>

    <script>
        ///////////////////////////////////////////////////////////////////////////////////////////
        // IMPORTING AND INTITIALIZING WEBGAZER EYE-TRACKING OPERATIONS
        //
        //
        //// In this area, the webgazer eyetracker is intitialized by gaining permission to utilize the device's webcam
        //// A preview image of the webcam footage is shown in the corner of the screen, and all webgazer activity is shut down when the page is closed 

        let gazeData = []; // Array to store raw gaze data
        let gazeTrackingEnabled = false;

        // Function to initialize WebGazer
        function startTracking() {
            console.log('Initializing WebGazer...');
            if (typeof webgazer === 'undefined') {
                console.error('WebGazer is not loaded.');
                return;
            }
    
            webgazer
                .setGazeListener((data, timestamp) => {
                    if (data) {
                        gazeData.push({
                            x: data.x, // X-coordinate
                            y: data.y, // Y-coordinate
                            timestamp: timestamp // Timestamp
                        });
                    }
                })
                .begin()
                .showVideoPreview(true)
                .showPredictionPoints(true);
    
            console.log('WebGazer initialized and tracking started.');
        }
    

        // Function to download gaze data as CSV
        function downloadGazeDataCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "X,Y,Timestamp\n"; // Add CSV header

            if (gazeData.length > 0) {
                gazeData.forEach(row => {
                    csvContent += `${row.x},${row.y},${row.timestamp}\n`;
                });
            } else {
                console.warn("No gaze data to download. Creating an empty file.");
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "raw_gaze_data.csv");
            document.body.appendChild(link); // Append link to body
            link.click(); // Trigger download
            document.body.removeChild(link); // Remove link after download
            console.log("Gaze data downloaded.");
        }

        // Keyboard shortcut handler
        document.addEventListener('keydown', function (event) {
            // Keyboard shortcut for downloading gaze data (Ctrl+D)
            if (event.ctrlKey && event.key === 'd') {
                event.preventDefault(); // Prevent default browser action
                downloadGazeDataCSV(); // Trigger CSV download
                console.log("Gaze data CSV downloaded!");
            }
        });

        // Automatically initialize WebGazer on page load
        window.onload = function () {
            console.log('Page loaded. Starting WebGazer...');
            if (typeof webgazer !== 'undefined') {
                startTracking();
                gazeTrackingEnabled = true;
            } else {
                console.error('WebGazer not loaded properly.');
            }
        };

        // Stop WebGazer when the page is closed
        window.onbeforeunload = function () {
            if (typeof webgazer !== 'undefined') {
                webgazer.end();
            }
        };
        ////
        ////
        ///////////////////////////////////////////////////////////////////////////////////////////
    </script>

    <script>
        ///////////////////////////////////////////////////////////////////////////////////////////
        // UPDATING VISUALS, QUESTIONS AND VISUALIZATIONS BASED ON PAGE NUMBER
        //
        //
        //// In this area, the researchers will be able to update the order and combination of questions, answers and visualiations 
        /// There will be three sets of questions along with 3 sets of corresponding answers, and two different types of visualizations

        let page_value = -1;        //Page number variable, used to track the current page state
        var question_var = 1;       //The index for which questions/answer options will be used: either 0, 1, or 2
        var visualization_var = 0;  //The binary index for which type of visualization will be used: either 0 or 1
        let answers = [];           //Variable to keep track of user answers
        let page_time = [];         //Variable to keep track of the time spent on each page by the user

        let startTime = new Date().getTime();   //Variable to keep track of the time spent on the current page. This begins as soon as the page is loaded, meaning the first value can most-likely be disgarded 

        const menuIntro = document.getElementById("introPage");             //Variable tied to the intro HTML page
        const menuBackground = document.getElementById("backgroundPage")    //Variable tied to the background information HTML page
        const menuQuestion = document.getElementById("questionPage")        //Variable tied to the main question HTML page
        const menuOutro = document.getElementById("outroPage");             //Variable tied to the final outro HTML page
        const continueButton = document.getElementById("pageButton");       //Variable tied to the page button HTML component
        const menuCalibration = document.getElementById("h_calibration");   //Variable tied to the eye-tracking calibration HTML page

        const v1 = document.createElement("img");   //Variable for temporary image until we have a final first visualization
        //Establish source file and size of first temporary visualization
        v1.src = "../p1.png";
        v1.style.width = "100%"
        v1.style.height = "100%"

        const v2 = document.createElement("img");   //Variable for temporary image until we have a final second visualization
        //Establish source file and size of second temporary visualization
        v2.src = "../p2.png"; 
        v2.style.width = "100%"
        v2.style.height = "100%"

        const visuals = [v1, v2]    //Variable to store both temporary visualizations

        //Function for disabling calibration once it is completed 
        function disableCalibration()
        {
            menuCalibration.style.display="none"
            menuBackground.style.display="flex";
        }
        window.disableCalibration = disableCalibration;

        //Function for iterationg through pages
        function changePage(ans=-1)
        {
            //Push the selected answer to the final list of answers
            if (ans != -1)
            {
                answers.push(ans);
            }

            //Iterate the page number with a limit of 13
            page_value = page_value + 1;

            //If the page number is over 12, calculate the final score of the user 
            if (page_value > questionNum)
            {
                final_score = checkAnswers(answers);
            }

            //Regardless of what happens, update the time variable to keep track of user duration
            const endTime = new Date().getTime();
            const timeSpent = (endTime - startTime) / 1000.0
            //Push the time spent on the page to the final duration tracker, and reset the current time tracker
            page_time.push(timeSpent);
            startTime = endTime;

            //Update the displayed visual on the page, based on the new value of page_value
            updateFrontEnd();
        }

        //Function for updating visuals based on the new value of page_value
        //Iterates through different if-statements to check whether the condition for displaying certain pages is met 
        function updateFrontEnd(is_calib = false)
        {
            
            //Perform the calibration sequence, which should not affect the page value
            if(is_calib == true && page_value == 0)
            {
                console.log("calibration sequence");
                menuBackground.style.display = "none";
                menuCalibration.style.display = "flex";
                window.startCalibration();
                return;
            }

            //If the current page is a question & visual page (page_value is between 1 and 15)
            if(page_value == 0)
            {
                document.getElementById("tree-container").appendChild(visuals[visualization_var]);
                menuIntro.style.display = "none";
                menuBackground.style.display = "flex";
            }
            else if(page_value > 0 && page_value <= 10)
            {
                //Remove the visualization
                menuBackground.style.display = "none";
                menuQuestion.style.display = "flex";

                document.getElementById("questionText").innerText = pageQuestions[question_var][page_value];
                document.getElementById("answersText").innerText = pageAnswers[question_var][page_value];
            }

            //If the current page has exceeded the number of questions, meaning it will now end the study simulation
            else if(page_value > 10)
            {
                //Navigate to the final end-page of the simulation
                menuQuestion.style.display = "none";
                menuOutro.style.display = "flex";
                continueButton.style.display="none";

                //Display the final score of the participant (OPTIONAL)
                document.getElementById("outroText").textContent = ("Thank you for participating!");

                console.log(answers);
                console.log(page_time)
            }
        }

        function checkAnswers(ans_list)
        {
            let correct_ans = 0
            for (i = 0; i < questionNum; i++)
            {
                if (ans_list[i] === pageSolutions[question_var][i])
                {
                    correct_ans++;
                }
            }
            return correct_ans;
        }
        ////
        ////
        ///////////////////////////////////////////////////////////////////////////////////////////
    </script>

    <script>
        ///////////////////////////////////////////////////////////////////////////////////////////
        // TRACKING AND ACTING-UPON USER KEYBAORD INPUTS
        //
        //
        //// In this area, keyboard-inputs are tracked and the necessary functions are acted upon, all preventing default browser actions
        //// The majority of these keyboard shortcuts will be ctrl + a corresponding letter key 

        //Event listener checking for keybard input 
        document.addEventListener('keydown', function (event) {
            //If the ctrl key is pressed, now perform a hotkey action based on the subsequent key pressed
            if (event.ctrlKey)
            {
                event.preventDefault();
                switch(event.key)
                {
                    //Keyboard shortcut for enabling AOI selection
                    case 'z':
                        enableAOISelection();
                        break;
                    //Keyboard shortcut for downloading the selected AOI selections
                    case 'x':
                        //Prevent default browser activity, and instead run the function to save AOI selections as a JSON file 
                        saveAOIs();
                        break;
                    //Keyboard shortcut for calling the calibration sequence
                    case 'c':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence 
                        updateFrontEnd(is_calib=true);
                        console.log("calibration");
                        break;
                    //Keyboard shortcut for updating the question/answer value to the first set of questions
                    case '1':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence 
                        question_var = 0;
                        break;
                    //Keyboard shortcut for updating the question/answer value to the second set of questions
                    case '2':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence 
                        question_var = 1;
                        break;
                    //Keyboard shortcut for updating the question/answer value to the third set of questions
                    case '3':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence 
                        question_var = 2;
                        break;
                    case '4':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence 
                        visualization_var = 0;
                        break;
                    case '5':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence
                        visualization_var = 1;
                        break;
                }   
            }
        });
        ////
        ////
        ///////////////////////////////////////////////////////////////////////////////////////////
    </script>
</body>