<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="assets/css/styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- <script src="assets/js/webgazer.js"></script> -->
    <script src="assets/js/aoi-selection.js"></script>
    <script src="assets/js/eyetracking.js"></script>
    <script src="assets/js/calibration.js"></script>

    <!--Imports for ontology visualizations in Javascript format-->
    <script src="assets/js/circle-packing.js"></script>
    <script src="assets/js/node-link.js"></script>
    <script src="assets/js/tree-map.js"></script>

    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <!--Imports for data files, originally JSON but translated to Javascript for functionality-->
    <script src="assets/json/pizza-baseline.js"></script>
    <script src="assets/json/pizza-treeMap.js"></script>
    <script src="assets/json/pizza-circlePack.js"></script>
    <script src="assets/json/music_base.js"></script>
    <script src="assets/json/restaurant_base.js"></script>
</head>

<!--Main body of the webpage-->
<body class="h_main">
    <!--Display for the introductory screen-->
    <div id="introPage" style="display:flex;flex-direction:column;justify-content:space-between;align-items:center;height:1080px;width:100%">
        <div class="h_intro_text">Data Visualization With Ontologies</div>
        <div class="h_intro_consent">

            <!--Consent Form-->
            <div style="height:100%;overflow-y:scroll;margin-bottom:10px;">
                <div class="h_consent_bullet_title">Introduction</div>
                <div class="h_consent_bullet_text">This study is conducted by a team of undergraduate and graduate student 
                    researchers under the supervision of Dr. Bo Fu as part of a research project that aims to evaluate interactive 
                    visualizations in their support for the human user when making sense of ontological relationships.
                </div>

                <div class="h_consent_bullet_title">Purpose and Objectives</div>
                <div class="h_consent_bullet_text">The goal of this study is to assess visualization techniques and the extent to which they can support human users during interactions with ontological relations. The findings from this research will inform the future design and development of visualization techniques.  
                </div>

                <div class="h_consent_bullet_title">Importance Of Research</div>
                <div class="h_consent_bullet_text">The research and data collected within this study will offer insights on the desirable visual attributes that can effectively illustrate relationships between ontological entities. The findings from this research will generate new knowledge contributing to the advancement of this field. 
                </div>

                <div class="h_consent_bullet_title">Participation Selection</div>
                <div class="h_consent_bullet_text">No prior knowledge of ontology or ontology mappings is required. Individuals who are eighteen years old or older are invited to participate.</div>

                <div class="h_consent_bullet_title">What is Involved?</div>
                <div class="h_consent_bullet_text">If you consent to voluntarily participate in this study, you will be asked to complete brief tutorials on ontologies and visualizations. You will be asked to take part in interviews and complete questionnaires to express your satisfaction with the given visualizations. An eye tracker will be used to observe your interaction with the given visualizations and your gaze data will be collected (such as how long your gaze was fixated on a particular visual cue). This study will take place in Room 128A in the Vivian Engineering Center (VEC), California State University of Long Beach.
                </div>

                <div class="h_consent_bullet_title">Duration</div>
                <div class="h_consent_bullet_text">The study is estimated to take approximately one hour of your time. It is advised that you set aside approximately 1.5 hours to accommodate potential delay.</div>

                <div class="h_consent_bullet_title">Risks</div>
                <div class="h_consent_bullet_text">There are no known or anticipated risks to you by participating in this research.</div>

                <div class="h_consent_bullet_title">Benefits</div>
                <div class="h_consent_bullet_text">The potential benefits of you participating in this study include contributing to the understanding of visualizations for ontological relationships and the field as a whole. This could lead to future advancements in the visualizations designed for ontological relations.
                </div>

                <div class="h_consent_bullet_title">Voluntary Participation</div>
                <div class="h_consent_bullet_text">Your participation in this research is entirely voluntary. You may withdraw at any moment without consequences nor explanation. If you do so, your data will be destroyed permanently. 
                </div>

                <div class="h_consent_bullet_title">Compensation</div>
                <div class="h_consent_bullet_text">The compensation for taking part in this study is $25 BeachBucks, which will be deposited directly into the account associated with your student ID.</div>

                <div class="h_consent_bullet_title">Anonymity</div>
                <div class="h_consent_bullet_text">All participants and the data generated in this study will be anonymized.</div>

                <div class="h_consent_bullet_title">Confidentiality</div>
                <div class="h_consent_bullet_text">All participants' information and the data collected in this study are anonymized. Your confidentiality and the confidentiality of the data are protected in secured storage, accessible by the research team only.
                </div>

                <div class="h_consent_bullet_title">Dissemination of Results</div>
                <div class="h_consent_bullet_text">It is anticipated that the results of this study will be shared with others in the following ways: scientific websites, articles, and presentations. Where used in publications, all data will be aggregated, and no personally identifiable information will be published. 
                </div>

                <div class="h_consent_bullet_title">Disposal of Data</div>
                <div class="h_consent_bullet_text">Data collected from this study will be safely kept during the duration of the study. Once completed the data will be disposed of permanently. </div>

                <div class="h_consent_bullet_title">Contact Information</div>
                <div class="h_consent_bullet_text">If you have any questions about this research, please contact Dr. Bo Fu (Bo.Fu@csulb.edu). If you have any questions about the conduct of this study protocol, particularly about providing informed consent and unexpected contingencies, please contact the IRB Office (IRB@csulb.edu). 
                </div>

                <!--
                <div class="h_consent_bullet_title">Consent</div>
                <div class="h_consent_bullet_text">By checking the box below, you indicate that you understand the above conditions of participation in this study, that you have had the opportunity to have your questions answered by the researcher, and that you consent to participate in this research.                     
                </div>
                -->
            </div>

            <div style="display:flex;flex-direction:row;justify-content:center;align-items:center;">
                <div style="font-size:15px;margin-right:10px;">I consent to all information stated above and agree to take part in the research study</div>
                <input type="checkbox" id="consentCheck">
            </div>
        </div>
        <button id="consentButton" class="h_begin_button" onclick="changePage()" disabled>Continue</button>
    </div>

    <script>
        ///////////////////////////////////////////////////////////////////////////////////////////
        // CHECKING FOR USER INPUT ON THE CONSENT FORM PAGE
        //
        //
        //// In this area, the eventlistener will watch for changes in the website (on this page, just the checkbox) and will update it based on whether the box has been checked or not 
        const checkbox = document.getElementById('consentCheck');
        const button = document.getElementById('consentButton');

        // Add an event listener to the checkbox
        checkbox.addEventListener('change', function () {
        // Enable or disable the button based on the checkbox state
        button.disabled = !checkbox.checked;
        });
        ////
        ////
        ///////////////////////////////////////////////////////////////////////////////////////////
    </script>

    <div id="backgroundPage" class="h_sub" style="display:none">
        <!--Dispaly for information regarding the ontology models used, and information that could make answering them easier and more intuitive-->
        <div class="h_intro_background">
            <div style="display:flex;height:90%;width:100%;background-color:rgb(240,240,240);flex-direction:column;">
                <div style="font-size:50px;padding:20px;color:rgb(25,25,25);">Tutorial</div>

                <div>
                    <div id="tutorial_title" class="h_background_bullet_title">DisjointWith</div>
                    <div id="tutorial_text" class="h_background_bullet_text">The classes do not and cannot share any subclasses or values. For example:<br>Class A is disjointWith Class B. Class A = [1, 2, 3], Class B = [4, 5, 6]</div>
                </div>
            </div>
            <button id="tutorial_button" class="h_begin_button" onclick="iterateTutorial()">Next</button>
        </div>
        <div class="h_visual">
            <div id="tree-container-tutorial" style="width:100%;height:100%;background-color:rgb(240,240,240);"></div>
        </div>
    </div>

    <script>
        ///////////////////////////////////////////////////////////////////////////////////////////
        // ITERATE THROUGH THE DIFFERENT PAGES OF THE TUTORIAL
        //
        //
        //// In this area, the tutorial pages for each ontology relationship are displayed. Once all have been shown, it will move onto the actual test
        let tutorial_value = 0;
        const tutorialTitle = document.getElementById("tutorial_title");
        const tutorialText = document.getElementById("tutorial_text");
        const tutorialButton = document.getElementById("tutorial_button");

        let titles = ["What is an Ontology?", 
            "DisjointWith", 
            "UnionOf",
            "IntersectionOf",
            "ComplementOf"]

        let tutorials = ["An ontology is like a detailed map of knowledge about a specific topic or domain. It organizes information by defining concepts, their properties, and how they relate to each other, much like a family tree or a blueprint."
            + "Think of it as a way to make sure everyone understands the same ideas and relationships in the same way when discussing or working with complex information."
            + "\n\nEntity = a single instance of a class"
            + "\n\nClass = a category or group of entities that all share similar characteristics"
            + "\n\nRelationship = a way in which two or more entities/classes in an ontology are connected or related"
            + "\n\nNext you will see a few different types of relationships you can expect to see during this study.",

            "An ontology relationship between classes where an instance cannot be part of two classes at the same time."
            + "\n\nAn example of this would be different types of musical dramas. The classes Opera, Operetta and Musical are all disjoint, meaning no class can be more than one of these at once.",

            "An ontology relationship that creates a single class/list out of the contents of others. Taken from logic operations, a union is all items put together from two lists, disregarding any duplicates. In our case: a class that contains all instances that belong to any number of classes, removing duplicates."
            + "\n\nAn example of this would be between two lists of famous operas. A union of these two lists would contain all operas that appear in the lists, with duplicates being removed.",

            "An ontology relationship that creates a single class/list out of the contents of others. Taken from logic operations, an intersection is all items that two lists share in common put into one. In our case: a class that contains all instances shared between two other classes."
            + "\n\nAn example of this would be between two lists of famous operas. An intersection of these two lists would contain only the operas appearing in both lists, and disregard all others.",

            "An ontology relationship between two classes where an instance can either belong to one class or the other. If it does not belong to one, it MUST belong to the other."
            + "\n\nAn example of this would be two meal options at a restaurant: standard options and vegetarian options. If an item is not standard, then it is vegetarian, and vice versa.",
            ]

        tutorialTitle.innerText = titles[0];
        tutorialText.innerText = tutorials[0];

        function iterateTutorial()
        {
            tutorial_value = tutorial_value + 1;
            tutorialTitle.innerText = titles[tutorial_value];
            tutorialText.innerText = tutorials[tutorial_value];

            console.log(tutorial_value);

            if (tutorial_value < 5)
            {
                document.getElementById("tree-container-tutorial").replaceChild(visuals_tutorial[tutorial_value], document.getElementById("tree-container-tutorial").firstChild);
            }

            if (tutorial_value == 4)
            {
                tutorialButton.innerText = "Begin Study"
            }
            else if (tutorial_value == 5)
            {
                changePage();
            }
        }

        const vt1 = document.createElement("img");   //Variable for temporary image until we have a final second visualization
        //Establish source file and size of second temporary visualization
        vt1.src = "../ontologyExample.png"; 
        vt1.style.width = "100%"
        vt1.style.height = "100%"

        const vt2 = nodeLink(MusicBaselineData);
        const vt3 = nodeLink(RestaurantBaselineData);

        const visuals_tutorial = [vt1, vt2, vt2, vt2, vt3]    //Variable to store both temporary visualizations

        document.getElementById("tree-container-tutorial").appendChild(visuals_tutorial[0])
        ////
        ////
        ///////////////////////////////////////////////////////////////////////////////////////////
    </script>

    <!--Display for questions and answers, used for questionaire participation-->
    <div id="questionPage" class="h_sub" style="display:none">
        <script>
            let pageState = 0;
        </script>

        <!--Div for questions and answers-->
        <div class="h_question">
            <!--Div for question and answer-option text-->
            <div class = "h_sub_question">
                <div id="questionText" style="padding:20px;width:100% - 40px;">
                    Question1
                </div>
                <div id="answersText" style="white-space: pre-line;padding:20px;width:100% - 40px;">
                    Answers1
                </div>
            </div>

            <!--Container for the answer buttons-->
            <div class="h_answer_box">
                <button id="pageButton" class="ans_button" onclick="changePage(0)">Answer A</button>
                <button id="pageButton" class="ans_button" onclick="changePage(1)">Answer B</button>
                <button id="pageButton" class="ans_button" onclick="changePage(2)">Answer C</button>
                <button id="pageButton" class="ans_button" onclick="changePage(3)">Answer D</button>
            </div>

            <!--Script containing the questions and answers for the question page-->
            <script>
                const questionNum = 10;

                //List of all questions
                const pageQuestions = 
                [{
                    1: "Question 1:\n\n Which class does the class #VegetarianPizza have a complementOf relationship with?",
                    2: "Question 2:\n\n Question 1-2",
                    3: "Question 3:\n\n Question 1-3",
                    4: "Question 4:\n\n Question 1-4",
                    5: "Question 5:\n\n Question 1-5",
                    6: "Question 6:\n\n Question 1-6",
                    7: "Question 7:\n\n Question 1-7",
                    8: "Question 8:\n\n Question 1-8",
                    9: "Question 9:\n\n Question 1-9",
                    10: "Question 10:\n\n Question 1-10",
                },
                {
                    1: "Question 1:\n\n Question 2-1",
                    2: "Question 2:\n\n Question 2-2",
                    3: "Question 3:\n\n Question 2-3",
                    4: "Question 4:\n\n Question 2-4",
                    5: "Question 5:\n\n Question 2-5",
                    6: "Question 6:\n\n Question 2-6",
                    7: "Question 7:\n\n Question 2-7",
                    8: "Question 8:\n\n Question 2-8",
                    9: "Question 9:\n\n Question 2-9",
                    10: "Question 10:\n\n Question 2-10",
                },
                {
                    1: "Question 1:\n\n Question 3-1",
                    2: "Question 2:\n\n Question 3-2",
                    3: "Question 3:\n\n Question 3-3",
                    4: "Question 4:\n\n Question 3-4",
                    5: "Question 5:\n\n Question 3-5",
                    6: "Question 6:\n\n Question 3-6",
                    7: "Question 7:\n\n Question 3-7",
                    8: "Question 8:\n\n Question 3-8",
                    9: "Question 9:\n\n Question 3-9",
                    10: "Question 10:\n\n Question 3-10",
                }];

                //List of all answers
                const pageAnswers = 
                [{
                    1: "A) MeatPizza\nB) SeafoodPizza\nC) NonVegetarianPizza\nD) None",
                    2: "A) Answer 1-2-1\nB) Answer 1-2-2\nC) Answer 1-2-3\nD) Answer 1-2-4",
                    3: "A) Answer 1-3-1\nB) Answer 1-3-2\nC) Answer 1-3-3\nD) Answer 1-3-4",
                    4: "A) Answer 1-4-1\nB) Answer 1-4-2\nC) Answer 1-4-3\nD) Answer 1-4-4",
                    5: "A) Answer 1-5-1\nB) Answer 1-5-2\nC) Answer 1-5-3\nD) Answer 1-5-4",
                    6: "A) Answer 1-6-1\nB) Answer 1-6-2\nC) Answer 1-6-3\nD) Answer 1-6-4",
                    7: "A) Answer 1-7-1\nB) Answer 1-7-2\nC) Answer 1-7-3\nD) Answer 1-7-4",
                    8: "A) Answer 1-8-1\nB) Answer 1-8-2\nC) Answer 1-8-3\nD) Answer 1-8-4",
                    9: "A) Answer 1-9-1\nB) Answer 1-9-2\nC) Answer 1-9-3\nD) Answer 1-9-4",
                    10: "A) Answer 1-10-1\nB) Answer 1-10-2\nC) Answer 1-10-3\nD) Answer 1-10-4",
                },
                {
                    1: "A) Answer 2-1-1\nB) Answer 2-1-2\nC) Answer 2-1-3\nD) Answer 2-1-4",
                    2: "A) Answer 2-2-1\nB) Answer 2-2-2\nC) Answer 2-2-3\nD) Answer 2-2-4",
                    3: "A) Answer 2-3-1\nB) Answer 2-3-2\nC) Answer 2-3-3\nD) Answer 2-3-4",
                    4: "A) Answer 2-4-1\nB) Answer 2-4-2\nC) Answer 2-4-3\nD) Answer 2-4-4",
                    5: "A) Answer 2-5-1\nB) Answer 2-5-2\nC) Answer 2-5-3\nD) Answer 2-5-4",
                    6: "A) Answer 2-6-1\nB) Answer 2-6-2\nC) Answer 2-6-3\nD) Answer 2-6-4",
                    7: "A) Answer 2-7-1\nB) Answer 2-7-2\nC) Answer 2-7-3\nD) Answer 2-7-4",
                    8: "A) Answer 2-8-1\nB) Answer 2-8-2\nC) Answer 2-8-3\nD) Answer 2-8-4",
                    9: "A) Answer 2-9-1\nB) Answer 2-9-2\nC) Answer 2-9-3\nD) Answer 2-9-4",
                    10: "A) Answer 2-10-1\nB) Answer 2-10-2\nC) Answer 2-10-3\nD) Answer 2-10-4",
                },
                {
                    1: "A) Answer 3-1-1\nB) Answer 3-1-2\nC) Answer 3-1-3\nD) Answer 3-1-4",
                    2: "A) Answer 3-2-1\nB) Answer 3-2-2\nC) Answer 3-2-3\nD) Answer 3-2-4",
                    3: "A) Answer 3-3-1\nB) Answer 3-3-2\nC) Answer 3-3-3\nD) Answer 3-3-4",
                    4: "A) Answer 3-4-1\nB) Answer 3-4-2\nC) Answer 3-4-3\nD) Answer 3-4-4",
                    5: "A) Answer 3-5-1\nB) Answer 3-5-2\nC) Answer 3-5-3\nD) Answer 3-5-4",
                    6: "A) Answer 3-6-1\nB) Answer 3-6-2\nC) Answer 3-6-3\nD) Answer 3-6-4",
                    7: "A) Answer 3-7-1\nB) Answer 3-7-2\nC) Answer 3-7-3\nD) Answer 3-7-4",
                    8: "A) Answer 3-8-1\nB) Answer 3-8-2\nC) Answer 3-8-3\nD) Answer 3-8-4",
                    9: "A) Answer 3-9-1\nB) Answer 3-9-2\nC) Answer 3-9-3\nD) Answer 3-9-4",
                    10: "A) Answer 3-10-1\nB) Answer 3-10-2\nC) Answer 3-10-3\nD) Answer 3-10-4",
                }
                ];

                //List of all correct answers (by index)
                const pageSolutions =   [[1, 0, 3, 2, 1, 2, 1, 0, 3, 2], 
                                        [1, 0, 3, 2, 1, 2, 1, 0, 3, 2], 
                                        [1, 0, 3, 2, 1, 2, 1, 0, 3, 2]];
            </script>
        </div>
        
        <!--Div for visualization, implementing D3 later on-->
        <div class="h_visual">
            <div id="tree-container" style="width:100%;height:100%;background-color:rgb(240,240,240);justify-content:center;align-items:center;"></div>
        </div>

        <canvas id="aoiCanvas" width="1920" height="1080" style="position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none;"></canvas>
        <!--<button onclick="enableAOISelection()" style="position: relative; z-index: 11;">Start AOI Selection</button>
        <button onclick="saveAOIs()" style="position: relative; z-index: 11; margin-top: 10px;">Save AOIs</button>-->
    </div>

    <!-- The parent container for calibration -->
    <div id="h_calibration" class="h_calibration" style="display:none">
        <div id="calibration-container" class="calibration_parent">
        <!-- Initializing the hidden canvas webgazer needs for calibration. This canvas is not visible -->
        <canvas id="plotting_canvas" style="display: none;"></canvas>
        <!-- The 9 clickable dots will be appended here by generateCalibrationDots() -->
        <div id="calibration-dots">
            <!-- dots get created dynamically in calibration.js -->
        </div>
    
        <!-- The popup that appears once you complete calibration -->
        <div id="calibration-score-popup" style="display:none;">
            <p id="calibration-score-text">
            Your calibration score: <span id="calibration-score-percentage"></span>%
            </p>
            <button id="retry-button">Retry</button>
            <button id="proceed-button" onclick="disableCalibration()">Proceed</button>
        </div>
        </div>
    </div>

    <!--Display for the final thank you and results page-->
    <div id="outroPage" class="h_sub" style="Display:none">
        <div id="outroText" class="h_outro">
            Final
        </div>
    </div>

    <div id="intermissionPage" class="h_sub" style="Display:none">
        <div id="outroText" class="h_outro">
            Visual 1 complete
        </div>
        <button id="pageButton" class="ans_button" onclick="changePage()">Continue</button>
    </div>

    <script>
        ///////////////////////////////////////////////////////////////////////////////////////////
        // IMPORTING AND INTITIALIZING WEBGAZER EYE-TRACKING OPERATIONS
        //
        //
        //// In this area, the webgazer eyetracker is intitialized by gaining permission to utilize the device's webcam
        //// A preview image of the webcam footage is shown in the corner of the screen, and all webgazer activity is shut down when the page is closed 


        let gazeData = []; // Array to store raw gaze data
        let gazeTrackingEnabled = false;

        // Function to initialize WebGazer
        function startTracking() {
            console.log('Initializing WebGazer...');
            if (typeof webgazer === 'undefined') {
                console.error('WebGazer is not loaded.');
                return;
            }
        
            // Start WebGazer tracking
            webgazer
                .setGazeListener((data, timestamp) => {
                    if (data) {
                        gazeData.push({
                            x: data.x, // X-coordinate
                            y: data.y, // Y-coordinate
                            timestamp: timestamp // Timestamp
                        });
                    }
                })
                .begin()
        
            // Explicitly hide prediction points
            webgazer.showPredictionPoints(false);
            console.log('Prediction points disabled after starting WebGazer.');
        
            const gazeDot = document.getElementById('webgazerGazeDot');
            if (gazeDot) {
                // Initially hide the gaze dot
                gazeDot.style.display = 'none';

                // Create a MutationObserver to monitor changes to the `style` attribute
                const observer = new MutationObserver((mutationsList) => {
                    mutationsList.forEach((mutation) => {
                        console.log('Mutation detected:', mutation);
                        if (gazeDot.style.display !== 'none') {
                            console.log('Overriding gaze dot display to none.');
                            gazeDot.style.display = 'none';
                        }
                    });
                });

                // Observe changes to the gaze dot element's style attribute
                observer.observe(gazeDot, {
                    attributes: true,
                    attributeFilter: ['style']
                });
            } else {
                console.warn('Gaze dot element not found.');
            }

        
            console.log('WebGazer initialized and tracking started.');
        }
        
        
        
        // Function to show the prediction dots
        function showPredictionDots() {
            const gazeDot = document.getElementById('webgazerGazeDot');
            if (gazeDot) {
                gazeDot.style.display = 'block'; // Show dots
                console.log('Prediction dots enabled.');
            } else {
                console.warn('Gaze dot element not found.');
            }
        }
        
        function hidePredictionDots() {
            const gazeDot = document.getElementById('webgazerGazeDot');
            if (gazeDot) {
                gazeDot.style.display = 'none'; // Hide dots
                console.log('Prediction dots disabled.');
            } else {
                console.warn('Gaze dot element not found.');
            }
        }
        

        // Function to enable prediction points during calibration
        function enablePredictionPoints() {
            if (typeof webgazer !== 'undefined') {
                webgazer.showPredictionPoints(true); // Enable prediction points
                console.log('Prediction points enabled for calibration.');
            }
        }

        // Function to disable prediction points after calibration
        function disablePredictionPoints() {
            if (typeof webgazer !== 'undefined') {
                webgazer.showPredictionPoints(false); // Disable prediction points
                console.log('Prediction points disabled after calibration.');
            }
        }


        // Function to download gaze data as CSV
        function downloadGazeDataCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "X,Y,Timestamp\n"; // Add CSV header

            if (gazeData.length > 0) {
                gazeData.forEach(row => {
                    csvContent += `${row.x},${row.y},${row.timestamp}\n`;
                });
            } else {
                console.warn("No gaze data to download. Creating an empty file.");
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "raw_gaze_data.csv");
            document.body.appendChild(link); // Append link to body
            link.click(); // Trigger download
            document.body.removeChild(link); // Remove link after download
            console.log("Gaze data downloaded.");
        }

        // Keyboard shortcut handler
        document.addEventListener('keydown', function (event) {
            // Keyboard shortcut for downloading gaze data (Ctrl+D)
            if (event.ctrlKey && event.key === 'd') {
                event.preventDefault(); // Prevent default browser action
                downloadGazeDataCSV(); // Trigger CSV download
                console.log("Gaze data CSV downloaded!");
            }
        });

        // Automatically initialize WebGazer on page load
        window.onload = function () {
            console.log('Page loaded. Starting WebGazer...');
            if (typeof webgazer !== 'undefined') {
                startTracking();
                gazeTrackingEnabled = true;
            } else {
                console.error('WebGazer not loaded properly.');
            }
        };

        // Stop WebGazer when the page is closed
        window.onbeforeunload = function () {
            if (typeof webgazer !== 'undefined') {
                webgazer.end();
            }
        };
        ////
        ////
        ///////////////////////////////////////////////////////////////////////////////////////////
    </script>

    <script>
        ///////////////////////////////////////////////////////////////////////////////////////////
        // UPDATING VISUALS, QUESTIONS AND VISUALIZATIONS BASED ON PAGE NUMBER
        //
        //
        //// In this area, the researchers will be able to update the order and combination of questions, answers and visualiations 
        /// There will be three sets of questions along with 3 sets of corresponding answers, and two different types of visualizations

        let page_value = -1;        //Page number variable, used to track the current page state
        let question_value = -1;    //Question number variable, reset between visualization/question sets
        var question_var = 1;       //The index for which questions/answer options will be used: either 0, 1, or 2
        var visualization_var = 0;  //The binary index for which type of visualization will be used: either 0 or 1
        let answers = [];           //Variable to keep track of user answers
        let page_time = [];         //Variable to keep track of the time spent on each page by the user
        let calibrated = false;

        let startTime = new Date().getTime();   //Variable to keep track of the time spent on the current page. This begins as soon as the page is loaded, meaning the first value can most-likely be disgarded 

        const menuIntro = document.getElementById("introPage");                 //Variable tied to the intro HTML page
        const menuBackground = document.getElementById("backgroundPage")        //Variable tied to the background information HTML page
        const menuQuestion = document.getElementById("questionPage")            //Variable tied to the main question HTML page
        const menuIntermission = document.getElementById("intermissionPage");   //Variable tied to the intermission page between visualizations
        const menuOutro = document.getElementById("outroPage");                 //Variable tied to the final outro HTML page
        const continueButton = document.getElementById("pageButton");           //Variable tied to the page button HTML component
        const menuCalibration = document.getElementById("h_calibration");       //Variable tied to the eye-tracking calibration HTML page

        /**
        const v1 = document.createElement("img");   //Variable for temporary image until we have a final first visualization
        //Establish source file and size of first temporary visualization
        v1.src = "../p1.png";
        v1.style.width = "100%"
        v1.style.height = "100%"
        */
        /*
        const v2 = document.createElement("img");   //Variable for temporary image until we have a final second visualization
        //Establish source file and size of second temporary visualization
        v2.src = "../p2.png"; 
        v2.style.width = "100%"
        v2.style.height = "100%"
        */
        

        const v1 = nodeLink(PizzaBaselineData);
        //const v2 = treeMap(PizzaTreeMapData);
        const v2 = packing(pizzaCirclePackData)

        const visuals = [v1, v2]    //Variable to store both temporary visualizations

        document.getElementById("tree-container").appendChild(visuals[visualization_var])

        //Function for disabling calibration once it is completed 
        function disableCalibration()
        {
            menuCalibration.style.display="none"
            menuQuestion.style.display="flex";
            document.getElementById("questionText").innerText = pageQuestions[question_var][question_value];
            document.getElementById("answersText").innerText = pageAnswers[question_var][question_value];
        }
        window.disableCalibration = disableCalibration;

        // Function to handle calibration sequence
        function startCalibration() {
            console.log('Starting calibration mode...');
            document.getElementById('h_calibration').style.display = 'flex'; // Show calibration UI
            document.getElementById('backgroundPage').style.display = 'none'; // Hide other pages

            showPredictionDots(); // Enable prediction points for calibration
        }

        // Function to exit calibration sequence
        function exitCalibration() {
            console.log('Exiting calibration mode...');
            document.getElementById('h_calibration').style.display = 'none'; // Hide calibration UI
            document.getElementById('backgroundPage').style.display = 'flex'; // Show main content

            hidePredictionDots(); // Disable prediction points after calibration
        }

        function downloadGazeDataCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "X,Y,Timestamp\n"; // Add CSV header
        
            if (gazeData.length > 0) {
                gazeData.forEach(row => {
                    csvContent += `${row.x},${row.y},${row.timestamp}\n`;
                });
            } else {
                console.warn("No gaze data to download. Creating an empty file.");
            }
        
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "raw_gaze_data.csv");
            document.body.appendChild(link); // Append link to body
            link.click(); // Trigger download
            document.body.removeChild(link); // Remove link after download
        }

        function changePage(ans = -1) {
            if (ans !== -1) answers.push(ans);
            page_value += 1; // Increment only once
            question_value += 1;
        
            if (page_value === 1 && !gazeTrackingEnabled) {
                startTrackingGaze(); // Start gaze tracking
                gazeTrackingEnabled = true; // Ensure tracking starts only once
            }
        
            if (page_value > questionNum) {
                final_score = checkAnswers(answers);
            }
        
            const endTime = new Date().getTime();
            const timeSpent = (endTime - startTime) / 1000.0;
            page_time.push(timeSpent);
            startTime = endTime;
        
            updateFrontEnd();
        }
        

        //Function for updating visuals based on the new value of page_value
        //Iterates through different if-statements to check whether the condition for displaying certain pages is met 
        function updateFrontEnd() 
        {
            //If the page value is equal to 0, begin the calibration sequence
            if (page_value == 0)
            {
                menuIntro.style.display = "none";
                menuBackground.style.display = "flex";
            }
            else if (page_value === 1) {
                if (!calibrated)
                {
                    menuIntro.style.display = "none";
                    menuBackground.style.display = "none";
                    menuQuestion.style.display = "none";
                    
                    // Show the calibration overlay
                    document.getElementById("h_calibration").style.display = "block";
                    
                    // Actually run the calibration code
                    window.startCalibration();
                    
                    console.log("calibration started");
                }
                else
                {
                    console.log("STOPPING CALIBRATION");
                    disableCalibration();
                }
            } 
            //If the page value is between 0 and 22, and not equal to 11, then perform the regular assessment frontend update
            else if (page_value > 0 && page_value <= 21 && page_value != 11) {
                menuBackground.style.display = "none";
                menuIntermission.style.display = "none";
                menuQuestion.style.display = "flex";
        
                document.getElementById("questionText").innerText = pageQuestions[question_var][question_value];
                document.getElementById("answersText").innerText = pageAnswers[question_var][question_value];
            } 
            //If the page value is equal to 11, cut in an intermission to change question/visualization styles
            else if (page_value == 11)
            {
                menuQuestion.style.display = "none";
                menuIntermission.style.display = "flex";
                question_value = 0;
            }
            //If the page value is above 21, then end the study, concluding that all questions have been answered 
            else if (page_value > 21) {
                menuQuestion.style.display = "none";
                menuOutro.style.display = "flex";
                continueButton.style.display = "none";
                document.getElementById("outroText").textContent = "Thank you for participating!";
                console.log(answers);
                console.log(page_time);
            }
        }
        

        function checkAnswers(ans_list)
        {
            let correct_ans = 0
            for (i = 0; i < questionNum; i++)
            {
                if (ans_list[i] === pageSolutions[question_var][i])
                {
                    correct_ans++;
                }
            }
            return correct_ans;
        }
        ////
        ////
        ///////////////////////////////////////////////////////////////////////////////////////////
    </script>

    <script>
        ///////////////////////////////////////////////////////////////////////////////////////////
        // TRACKING AND ACTING-UPON USER KEYBAORD INPUTS
        //
        //
        //// In this area, keyboard-inputs are tracked and the necessary functions are acted upon, all preventing default browser actions
        //// The majority of these keyboard shortcuts will be ctrl + a corresponding letter key 

        //Event listener checking for keybard input 
        document.addEventListener('keydown', function (event) {
            //If the ctrl key is pressed, now perform a hotkey action based on the subsequent key pressed
            if (event.ctrlKey)
            {
                event.preventDefault();
                switch(event.key)
                {
                    //Keyboard shortcut for enabling AOI selection
                    case 'z':
                        enableAOISelection();
                        break;
                    //Keyboard shortcut for downloading the selected AOI selections
                    case 'x':
                        //Prevent default browser activity, and instead run the function to save AOI selections as a JSON file 
                        saveAOIs();
                        break;  
                    //Keyboard shortcut for updating the question/answer value to the first set of questions
                    case '1':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence 
                        question_var = 0;
                        
                        break;
                    //Keyboard shortcut for updating the question/answer value to the second set of questions
                    case '2':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence 
                        question_var = 1;
                        
                        break;
                    //Keyboard shortcut for updating the question/answer value to the third set of questions
                    case '3':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence 
                        question_var = 2;
                        
                        break;
                    case '4':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence 
                        console.log("Visual set: 1");
                        visualization_var = 0;
                        document.getElementById("tree-container").replaceChild(visuals[visualization_var], document.getElementById("tree-container").firstChild);
                        
                        break;
                    case '5':
                        //Prevent default browser activity, and instead run the function to begin the calibration sequence
                        console.log("Visual set: 2");
                        visualization_var = 1;
                        document.getElementById("tree-container").replaceChild(visuals[visualization_var], document.getElementById("tree-container").firstChild);
                        
                        break;
                    case 'p':
                        disableCalibration();
                        break;
                }   
            }
        });
        ////
        ////
        ///////////////////////////////////////////////////////////////////////////////////////////
    </script>
</body>